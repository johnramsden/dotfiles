#!/usr/bin/env bash
set -euo pipefail

# Hash of ansible files - changing any triggers re-run
# {{ include "dot_bootstrap/setup.yml" | sha256sum }}
# {{ include "dot_bootstrap/tasks/arch.yml" | sha256sum }}
# {{ include "dot_bootstrap/tasks/canonical.yml" | sha256sum }}
# {{ include "dot_bootstrap/tasks/external_repos.yml" | sha256sum }}
# {{ include "dot_bootstrap/tasks/snap_packages.yml" | sha256sum }}
# {{ include "dot_bootstrap/vars/external_repos.yml" | sha256sum }}

echo "=== Running Ansible Bootstrap ==="

if ! command -v ansible-playbook &> /dev/null; then
    echo "ERROR: ansible-playbook not found. Run install script first."
    exit 1
fi

PLAYBOOK="{{ joinPath .chezmoi.sourceDir "dot_bootstrap/setup.yml" }}"

# Build ansible-playbook arguments
ANSIBLE_ARGS=("$PLAYBOOK" "--ask-become-pass")

# Support dry-run mode via environment variable
if [[ "${BOOTSTRAP_DRY_RUN:-}" == "1" || "${BOOTSTRAP_DRY_RUN:-}" == "true" ]]; then
    echo "DRY-RUN MODE: No changes will be made"
    ANSIBLE_ARGS+=("--check" "--diff")
fi

echo "Running playbook: $PLAYBOOK"
echo ""

ansible-playbook "${ANSIBLE_ARGS[@]}"

echo ""
echo "âœ“ Ansible bootstrap complete"
